╔═══════════════════════════════════════════════════════════════════════════════╗
║                    GreenWatts 2FA Authentication Flow                         ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                              USER LOGIN FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │   User Opens │
    │  index.html  │
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ Enter Username│
    │  & Password   │
    └──────┬───────┘
           │
           ▼
    ┌──────────────────┐
    │ Validate         │
    │ Credentials      │
    └──────┬───────────┘
           │
           ├─────────────────────────────────────────────┐
           │                                             │
           ▼                                             ▼
    ┌──────────────┐                            ┌──────────────┐
    │   Invalid    │                            │    Valid     │
    │ Credentials  │                            │ Credentials  │
    └──────┬───────┘                            └──────┬───────┘
           │                                           │
           ▼                                           ▼
    ┌──────────────┐                     ┌─────────────────────┐
    │ Show Error   │                     │ Generate Device     │
    │ Message      │                     │ Fingerprint         │
    └──────────────┘                     │ (SHA256 of UA + IP) │
                                         └──────┬──────────────┘
                                                │
                                                ▼
                                         ┌─────────────────────┐
                                         │ Check if Device     │
                                         │ is Trusted?         │
                                         └──────┬──────────────┘
                                                │
                        ┌───────────────────────┼───────────────────────┐
                        │                       │                       │
                        ▼                       ▼                       ▼
                 ┌──────────────┐      ┌──────────────┐       ┌──────────────┐
                 │   TRUSTED    │      │  NOT TRUSTED │       │  NEW DEVICE  │
                 │   DEVICE     │      │   (Expired)  │       │ (First Time) │
                 └──────┬───────┘      └──────┬───────┘       └──────┬───────┘
                        │                     │                       │
                        │                     └───────────┬───────────┘
                        │                                 │
                        │                                 ▼
                        │                      ┌─────────────────────┐
                        │                      │ Generate 6-digit    │
                        │                      │ Random OTP          │
                        │                      └──────┬──────────────┘
                        │                             │
                        │                             ▼
                        │                      ┌─────────────────────┐
                        │                      │ Store OTP in Cache  │
                        │                      │ (10 min expiry)     │
                        │                      └──────┬──────────────┘
                        │                             │
                        │                             ▼
                        │                      ┌─────────────────────┐
                        │                      │ Send OTP via        │
                        │                      │ Gmail API           │
                        │                      └──────┬──────────────┘
                        │                             │
                        │                             ├──────────────────┐
                        │                             │                  │
                        │                             ▼                  ▼
                        │                      ┌──────────────┐   ┌──────────────┐
                        │                      │   Success    │   │    Failed    │
                        │                      └──────┬───────┘   └──────┬───────┘
                        │                             │                  │
                        │                             ▼                  ▼
                        │                      ┌──────────────┐   ┌──────────────┐
                        │                      │ Redirect to  │   │ Show Error   │
                        │                      │ verify_otp   │   │ Message      │
                        │                      │ page         │   └──────────────┘
                        │                      └──────┬───────┘
                        │                             │
                        │                             ▼
                        │                      ┌──────────────────────┐
                        │                      │ User Enters OTP      │
                        │                      │ (6 digits)           │
                        │                      └──────┬───────────────┘
                        │                             │
                        │                             ▼
                        │                      ┌──────────────────────┐
                        │                      │ Verify OTP           │
                        │                      │ (Check Cache)        │
                        │                      └──────┬───────────────┘
                        │                             │
                        │                             ├──────────────────┐
                        │                             │                  │
                        │                             ▼                  ▼
                        │                      ┌──────────────┐   ┌──────────────┐
                        │                      │   Valid OTP  │   │ Invalid/     │
                        │                      │              │   │ Expired OTP  │
                        │                      └──────┬───────┘   └──────┬───────┘
                        │                             │                  │
                        │                             ▼                  ▼
                        │                      ┌──────────────────┐ ┌──────────────┐
                        │                      │ Delete OTP from  │ │ Show Error   │
                        │                      │ Cache            │ │ Message      │
                        │                      └──────┬───────────┘ └──────────────┘
                        │                             │
                        │                             ▼
                        │                      ┌──────────────────────┐
                        │                      │ Trust Device         │
                        │                      │ (Store in Cache      │
                        │                      │  for 30 days)        │
                        │                      └──────┬───────────────┘
                        │                             │
                        └─────────────────────────────┘
                                                      │
                                                      ▼
                                               ┌──────────────┐
                                               │ Login User   │
                                               │ (Django Auth)│
                                               └──────┬───────┘
                                                      │
                                                      ▼
                                               ┌──────────────┐
                                               │ Redirect to  │
                                               │ Dashboard    │
                                               └──────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                           CACHE STORAGE STRUCTURE                            │
└─────────────────────────────────────────────────────────────────────────────┘

    Cache Key: otp_{username}
    Value: "123456" (6-digit string)
    Expiry: 600 seconds (10 minutes)
    
    Cache Key: trusted_device_{username}_{device_fingerprint}
    Value: True
    Expiry: 2592000 seconds (30 days)


┌─────────────────────────────────────────────────────────────────────────────┐
│                         DEVICE FINGERPRINT GENERATION                        │
└─────────────────────────────────────────────────────────────────────────────┘

    Input:
    ┌─────────────────────────────────────────────────────────────┐
    │ User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)...   │
    │ IP Address: 192.168.1.100                                   │
    └─────────────────────────────────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ Concatenate Strings   │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ SHA256 Hash           │
                    └───────────┬───────────┘
                                │
                                ▼
    Output:
    ┌─────────────────────────────────────────────────────────────┐
    │ a3f5c8d9e2b1f4a6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6 │
    └─────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                            EMAIL OTP FORMAT                                  │
└─────────────────────────────────────────────────────────────────────────────┘

    From: your_email@gmail.com
    To: user@example.com
    Subject: GreenWatts - Login Verification Code
    
    ┌─────────────────────────────────────────────────────────────┐
    │ Hello,                                                       │
    │                                                              │
    │ Your verification code is: 123456                           │
    │                                                              │
    │ This code will expire in 10 minutes.                        │
    │                                                              │
    │ If you didn't request this code, please ignore this email.  │
    │                                                              │
    │ Best regards,                                                │
    │ GreenWatts Team                                              │
    └─────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                          SECURITY TIMELINE                                   │
└─────────────────────────────────────────────────────────────────────────────┘

    Day 0: User logs in from Device A
           ├─ OTP sent and verified
           └─ Device A trusted for 30 days
    
    Day 1-29: User logs in from Device A
              └─ No OTP required (trusted device)
    
    Day 30: Device trust expires
            └─ OTP required again
    
    Day 0: User logs in from Device B (different browser/computer)
           └─ OTP required (new device)


┌─────────────────────────────────────────────────────────────────────────────┐
│                         COMPONENT INTERACTION                                │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────┐         ┌──────────────┐         ┌──────────────┐
    │   Browser    │────────▶│    Django    │────────▶│    Cache     │
    │              │         │    Views     │         │   (OTP)      │
    └──────────────┘         └──────┬───────┘         └──────────────┘
                                    │
                                    │
                                    ▼
                             ┌──────────────┐
                             │  two_factor  │
                             │     .py      │
                             └──────┬───────┘
                                    │
                                    ▼
                             ┌──────────────┐
                             │  gmail_api   │
                             │     .py      │
                             └──────┬───────┘
                                    │
                                    ▼
                             ┌──────────────┐
                             │  Gmail API   │
                             │   (Google)   │
                             └──────┬───────┘
                                    │
                                    ▼
                             ┌──────────────┐
                             │ User's Email │
                             │   Inbox      │
                             └──────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                              KEY METRICS                                     │
└─────────────────────────────────────────────────────────────────────────────┘

    OTP Generation Time:     < 1 second
    Email Delivery Time:     5-30 seconds
    OTP Expiry:              10 minutes
    Device Trust Duration:   30 days
    Cache Memory per User:   ~1 KB
    Gmail API Rate Limit:    1 billion requests/day


═══════════════════════════════════════════════════════════════════════════════
                            END OF FLOW DIAGRAM
═══════════════════════════════════════════════════════════════════════════════
